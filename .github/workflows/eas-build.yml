name: "EAS Build Reusable"

on:
  workflow_call:
    inputs:
      environment:
        required: true
        type: string # staging | production
      profile:
        required: true
        type: string # preview | production | development
      platform:
        required: true
        type: string # android | ios | all
      submit:
        required: false
        type: boolean
        default: false # Only submit on production
    secrets:
      EXPO_TOKEN:
        required: true
      DOTENV_KEY_STAGING:
        required: false
      DOTENV_KEY_PRODUCTION:
        required: false
      # EXPO_PROJECT_ID:
      #   required: true
      # API_PUBLIC_URL:
      #   required: true
      # GRAPHQL_URL:
      #   required: true
      # SENTRY_DSN:
      #   required: true
      # SENTRY_AUTH_TOKEN:
      #   required: false

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 22.14.0
          cache: npm

      - name: Setup Expo / EAS
        uses: expo/expo-github-action@v8
        with:
          eas-version: latest
          expo-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: Install deps
        run: npm ci

      # ─────────────────────────────────────────────────────────
      # Pull app env from Env Vault (NON-INTERACTIVE)
      # ─────────────────────────────────────────────────────────
      - name: Pull env from Env Vault
        shell: bash
        run: |
          set -euo pipefail

          # Ensure the encrypted vault file exists in the current dir
          if [ ! -f ".env.vault" ]; then
            echo "::error::.env.vault not found in repo root (checkout path)."
            exit 1
          fi

          # Pick the correct DOTENV_KEY for the requested environment
          if [ "${{ inputs.environment }}" = "staging" ]; then
            export DOTENV_KEY="${{ secrets.DOTENV_KEY_STAGING }}"
          else
            export DOTENV_KEY="${{ secrets.DOTENV_KEY_PRODUCTION }}"
          fi

          if [ -z "${DOTENV_KEY:-}" ]; then
            echo "::error::DOTENV_KEY is empty; check GitHub Secrets."
            exit 1
          fi

          # Pull to a local .env for this job (no prompts, no browser)
          npx dotenv-vault@latest pull --yes --environment "${{ inputs.environment }}" --output .env

          # Sanity: show the keys (names only) we loaded (don’t print values)
          echo "Loaded keys from vault:"
          cut -d= -f1 .env | sed 's/^/- /'

          # Export all keys to this job's environment
          set -a
          source .env
          set +a

          # Optional hard checks: fail if any required vars are missing
          required_vars=(REACT_APP_PUBLIC_URL REACT_APP_GRAPHQL_URL SENTRY_DSN SENTRY_AUTH_TOKEN)
          for v in "${required_vars[@]}"; do
            if [ -z "${!v:-}" ]; then
              echo "::error::Missing required env var: $v"
              exit 1
            fi
          done

      # # Set env based on input
      # - name: Set App Env Vars
      #   run: |
      #     echo "EXPO_PROJECT_ID=${{ secrets.EXPO_PROJECT_ID }}" >> $GITHUB_ENV

      #     echo "REACT_APP_PUBLIC_URL=${{ secrets.API_PUBLIC_URL }}" >> $GITHUB_ENV
      #     echo "REACT_APP_GRAPHQL_URL=${{ secrets.GRAPHQL_URL }}" >> $GITHUB_ENV
      #     echo "SENTRY_DSN=${{ secrets.SENTRY_DSN }}" >> $GITHUB_ENV
      #     echo "SENTRY_AUTH_TOKEN=${{ secrets.SENTRY_AUTH_TOKEN }}" >> $GITHUB_ENV

      # - name: Push env to EAS
      #   run: |
      #     # Only push envs that exist for the given environment
      #     eas env:create --environment ${{ inputs.profile }} --name REACT_APP_PUBLIC_URL --value "$REACT_APP_PUBLIC_URL" --visibility sensitive --non-interactive --force
      #     eas env:create --environment ${{ inputs.profile }} --name REACT_APP_GRAPHQL_URL --value "$REACT_APP_GRAPHQL_URL" --visibility sensitive --non-interactive --force
      #     eas env:create --environment ${{ inputs.profile }} --name SENTRY_DSN --value "$SENTRY_DSN" --visibility sensitive --non-interactive --force
      #     eas env:create --environment ${{ inputs.profile }} --name SENTRY_AUTH_TOKEN --value "$SENTRY_AUTH_TOKEN" --visibility sensitive --non-interactive --force

      - name: Push env to EAS
        shell: bash
        run: |
          set -euo pipefail

          push_var () {
            local name="$1"; local value="${!1:-}"; local visibility="$2"
            if [ -n "$value" ]; then
              eas env:create --environment ${{ inputs.profile }} \
                --name "$name" --value "$value" \
                --visibility "$visibility" --non-interactive --force
            else
              echo "Skipping $name (unset)"
            fi
          }

          # Sensitive by default
          push_var REACT_APP_PUBLIC_URL   sensitive
          push_var REACT_APP_GRAPHQL_URL  sensitive
          push_var SENTRY_DSN             sensitive
          push_var SENTRY_AUTH_TOKEN      sensitive

      - name: Build on EAS
        run: |
          if [[ "${{ inputs.platform }}" == "all" ]]; then
            eas build --platform android --profile ${{ inputs.profile }} --non-interactive --no-wait
            eas build --platform ios --profile ${{ inputs.profile }} --non-interactive --no-wait
          else
            eas build --platform ${{ inputs.platform }} --profile ${{ inputs.profile }} --non-interactive --no-wait
          fi

      - name: Submit to Play Store (optional)
        if: ${{ inputs.submit && inputs.environment == 'production' }}
        run: |
          eas submit -p ${{ inputs.platform }} --latest --profile ${{ inputs.profile }} --non-interactive
