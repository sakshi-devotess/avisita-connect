name: "EAS Build Reusable"

on:
  workflow_call:
    inputs:
      environment:
        required: true
        type: string # staging | production
      profile:
        required: true
        type: string # preview | production | development
      platform:
        required: true
        type: string # android | ios | all
      submit:
        required: false
        type: boolean
        default: false # Only submit on production
    secrets:
      EXPO_TOKEN:
        required: true
      DOTENV_KEY_STAGING:
        required: false
      DOTENV_ME:
        required: false

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 22.14.0
          cache: npm

      - name: Setup Expo / EAS
        uses: expo/expo-github-action@v8
        with:
          eas-version: latest
          expo-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: Install deps
        run: npm ci

      - name: Pull app env from Env Vault (no browser) + persist
        shell: bash
        run: |
          npx dotenv-vault@latest pull "${{ inputs.environment }}" .env --yes --dotenvMe="${{ secrets.DOTENV_ME }}"

          echo "Loaded env keys:"
          cut -d= -f1 .env | sed 's/^/- /'

          # Load into this step
          set -a
          source .env
          set +a

          # ---- Persist to later steps via $GITHUB_ENV ----
          persist () {
            name="$1"; val="${!1:-}"
            if [ -n "$val" ]; then
              printf '%s=%s\n' "$name" "$val" >> "$GITHUB_ENV"
            else
              echo "::warning::$name not set; will be missing in later steps"
            fi
          }

          # Persist the exact names your push step expects
          persist REACT_APP_PUBLIC_URL
          persist REACT_APP_GRAPHQL_URL
          persist SENTRY_DSN
          persist SENTRY_AUTH_TOKEN

      # - name: Push env to EAS
      #   shell: bash
      #   run: |
      #     # Helper to push only set vars
      #     push_var () {
      #       name="$1"; visibility="$2"; val="${!1:-}"
      #       if [ -n "$val" ]; then
      #         eas env:create --environment ${{ inputs.profile }} \
      #           --name "$name" --value "$val" \
      #           --visibility "$visibility" --non-interactive --force
      #       else
      #         echo "Skip $name (unset)"
      #       fi
      #     }

      #     # Sensitive by default
      #     push_var REACT_APP_PUBLIC_URL   sensitive
      #     push_var REACT_APP_GRAPHQL_URL  sensitive
      #     push_var SENTRY_DSN             sensitive
      #     push_var SENTRY_AUTH_TOKEN      sensitive
      - name: Push env to EAS (create only if missing)
        shell: bash
        run: |
          # Tries to create; if it already exists, we skip. Any other error -> fail.
          push_if_missing () {
            local name="$1"; local visibility="$2"; local val="${!1:-}"
            if [ -z "$val" ]; then
              echo "Skip $name (unset)"
              return 0
            fi

            # Attempt create WITHOUT --force so it fails if it exists
            set +e
            errfile="$(mktemp)"
            eas env:create \
              --environment "${{ inputs.profile }}" \
              --name "$name" \
              --value "$val" \
              --visibility "$visibility" \
              --non-interactive 2> "$errfile"
            status=$?
            set -e

            if [ $status -eq 0 ]; then
              echo "Created $name"
            else
              if grep -qi "already exists" "$errfile"; then
                echo "Skip $name (already exists)"
              else
                echo "::error::Failed to create $name"
                cat "$errfile"
                exit $status
              fi
            fi
            rm -f "$errfile"
          }

          # Sensitive by default
          push_if_missing REACT_APP_PUBLIC_URL  sensitive
          push_if_missing REACT_APP_GRAPHQL_URL sensitive
          push_if_missing SENTRY_DSN            sensitive
          push_if_missing SENTRY_AUTH_TOKEN     sensitive

      - name: Build on EAS
        run: |
          if [[ "${{ inputs.platform }}" == "all" ]]; then
            eas build --platform android --profile ${{ inputs.profile }} --non-interactive --no-wait
            eas build --platform ios --profile ${{ inputs.profile }} --non-interactive --no-wait
          else
            eas build --platform ${{ inputs.platform }} --profile ${{ inputs.profile }} --non-interactive --no-wait
          fi

      - name: Submit to Play Store (optional)
        if: ${{ inputs.submit && inputs.environment == 'production' }}
        run: |
          eas submit -p ${{ inputs.platform }} --latest --profile ${{ inputs.profile }} --non-interactive
